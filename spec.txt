APP SPEC â€” "Save to Airtable"  (Current Implementation v2.1)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0. Goal
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Chrome browser extension with instant auto-save functionality.
â€¢ Capture Title, URL (editable), Tags â†’ write to Airtable Units table.
â€¢ Smart content type detection and URL-based deduplication.
â€¢ Real-time change tracking with conditional updates.
â€¢ Form population from existing entries for easy editing.
â€¢ Button-only feedback system (no toast messages).
â€¢ Delete functionality with confirmation dialog.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Airtable Schema
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE: env AIRTABLE_BASE_ID
TABLE: Units (default) or env AIRTABLE_TABLE

Field         Type            Required    Filled by app   Value
------------  --------------  ----------  -------------   -------------------------
Name          Single-line     yes         yes             page title
Link          URL             yes         yes             canonical URL
Tags          Multiple-select no          yes             array of tag strings
Status        Single-select   no          yes             "To do" (default for new entries)
Type          Single-select   no          yes             auto-detected content type

Required Single-Select Options:
Status: "To do", "In progress", "Done"
Type: "Twitter thread", "Reddit thread", "Video", "Article"

Content Type Detection Rules (by hostname):
â€¢ twitter.com, x.com â†’ "Twitter thread"
â€¢ reddit.com â†’ "Reddit thread"  
â€¢ youtube.com, vimeo.com, twitch.tv, tiktok.com â†’ "Video"
â€¢ all others â†’ "Article"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2. Backend API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Platform: Vercel Serverless Functions
Environment Variables:
  AIRTABLE_PAT          - Personal Access Token
  AIRTABLE_BASE_ID      - Base identifier  
  AIRTABLE_TABLE=Units  - Table name (optional, defaults to "Units")

Base URL: https://airtable-extension-martriays-projects.vercel.app

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/save                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Purpose: Save or update a record in Airtable                       â”‚
â”‚                                                                     â”‚
â”‚ Request Body:                                                       â”‚
â”‚ {                                                                   â”‚
â”‚   "url": "https://example.com/page",                               â”‚
â”‚   "title": "Page Title",                                           â”‚
â”‚   "tags": ["tag1", "tag2"],                                        â”‚
â”‚   "source": "Extension" | "iOS Shortcut",                          â”‚
â”‚   "forceUpdate": boolean (optional),                               â”‚
â”‚   "recordId": "recXXXXXXXXXXXXXX" (optional)                       â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Response (New Entry):                                               â”‚
â”‚ {                                                                   â”‚
â”‚   "duplicate": false,                                               â”‚
â”‚   "id": "recXXXXXXXXXXXXXX"                                         â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Response (Duplicate Found, No Force Update):                       â”‚
â”‚ {                                                                   â”‚
â”‚   "duplicate": true,                                                â”‚
â”‚   "existingId": "recXXXXXXXXXXXXXX",                                â”‚
â”‚   "existingData": {                                                 â”‚
â”‚     "title": "Existing Title",                                     â”‚
â”‚     "tags": ["existing", "tags"]                                   â”‚
â”‚   }                                                                 â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Response (Updated Existing):                                        â”‚
â”‚ {                                                                   â”‚
â”‚   "duplicate": true,                                                â”‚
â”‚   "existingId": "recXXXXXXXXXXXXXX"                                 â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Error Response:                                                     â”‚
â”‚ {                                                                   â”‚
â”‚   "error": "Error message",                                        â”‚
â”‚   "details": "Detailed error info"                                 â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /api/tags                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Purpose: Fetch all unique tags from Airtable for typeahead         â”‚
â”‚                                                                     â”‚
â”‚ Response:                                                           â”‚
â”‚ {                                                                   â”‚
â”‚   "tags": ["tag1", "tag2", "tag3"],                                â”‚
â”‚   "count": 3                                                       â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Error Response:                                                     â”‚
â”‚ {                                                                   â”‚
â”‚   "error": "Error message",                                        â”‚
â”‚   "details": "Detailed error info"                                 â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DELETE /api/delete                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Purpose: Delete a record from Airtable                             â”‚
â”‚                                                                     â”‚
â”‚ Request Body:                                                       â”‚
â”‚ {                                                                   â”‚
â”‚   "recordId": "recXXXXXXXXXXXXXX"                                   â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Response:                                                           â”‚
â”‚ {                                                                   â”‚
â”‚   "success": true                                                   â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Error Response:                                                     â”‚
â”‚ {                                                                   â”‚
â”‚   "success": false,                                                 â”‚
â”‚   "error": "Error message",                                        â”‚
â”‚   "details": "Detailed error info"                                 â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Processing Logic (/api/save):
1. Canonicalize URL (canonicalize function)
   â€¢ lower-case scheme+host, drop trailing "/"
   â€¢ strip tracking params: utm_*, gclid, fbclid, yclid, mc_*, irclickid,
     spm, gbraid, wbraid, vero_*, ref, ref_*
   â€¢ YouTube-specific: list, index, t, start, end, feature, app, si, pp,
     ab_channel, source, kw, gws_rd, ei, ved, usg, sa, rlz, biw, bih
   â€¢ Twitter/X-specific: s (sharing parameter)
2. Dedup by URL (findByUrl function)
   GET Units?filterByFormula={Link}="canonical_url"
   if exists AND !forceUpdate â†’ return 200 {duplicate:true,existingId,existingData:{title,tags}}
   if exists AND forceUpdate â†’ update record, return 200 {duplicate:true,existingId}
3. Detect content type (detectContentType function)
   hostname-based: twitter.com/x.com â†’ "Twitter thread"
                   reddit.com â†’ "Reddit thread"
                   youtube.com/vimeo.com/twitch.tv/tiktok.com â†’ "Video"
                   default â†’ "Article"
4. If unique (create function)
   POST Units {Name, Link, Tags, Status:"To do", Type:detected_type}
   return 201 {duplicate:false,id}
Errors â†’ 4xx/5xx {error,details}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3. Browser Extension  (MV3)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tech Stack: React + TypeScript + Vite

manifest.json (auto-generated by Vite plugin):
{
  "manifest_version": 3,
  "name": "Save to Airtable",
  "version": "1.0.0",
  "permissions": ["storage","activeTab"],
  "host_permissions": ["https://*/*", "http://*/*"],
  "action": { "default_popup": "popup.html" },
  "background": { "service_worker": "background.js" }
}

popup.tsx (React component):
 Title  <textarea value={title} onChange={handleTitleChange} rows={2}>
 URL    <textarea value={url} onChange={handleUrlChange} rows={2}>
 Tags   <input value={tags} onChange={handleTagsChange} (with typeahead)>
        [Save/Update Button] [ğŸ—‘ï¸ Delete Button] (no toast messages)

Behavior:
â€¢ On mount (useEffect)
    â€“ chrome.tabs.query â†’ fill title + url from active tab
    â€“ fetch("/api/tags") â†’ populate availableTags for suggestions
    â€“ performSave(url, title, []) â†’ auto-save immediately
â€¢ On input change â†’ checkForChanges() â†’ set hasUnsavedChanges flag
â€¢ Button states (ONLY feedback mechanism):
    â€“ isLoading: "Saving..." (gray, disabled)
    â€“ !hasUnsavedChanges && savedRecordId: "Saved" (green, disabled)
    â€“ hasUnsavedChanges: "Update Changes" (orange, enabled)
    â€“ default: "Save to Airtable" (blue, enabled)
â€¢ Delete button (ğŸ—‘ï¸):
    â€“ Only visible when savedRecordId exists
    â€“ Shows confirmation dialog before deletion
    â€“ Red background, 36x44px, trash emoji
    â€“ Disabled during isDeleting or isLoading states
â€¢ performSave()
    POST /api/save
    duplicate with existingData â†’ populate form fields with current values
    duplicate with forceUpdate â†’ update existing record
    created â†’ set savedRecordId, mark as saved
    error â†’ keep in error state (no toast)
â€¢ Form population: When duplicate found, auto-fill title + tags from Airtable
â€¢ Tag suggestions: typeahead filtering from availableTags, comma-separated
â€¢ Update workflow: forceUpdate=true when hasUnsavedChanges && savedRecordId
â€¢ Delete workflow: calls DELETE /api/delete, resets form state on success

Dependencies: react, react-dom (no Chakra UI, no axios, no toast library)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4. Development Tools
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Standard build process: `npm run build` creates production-ready extension
â€¢ Manual testing: Load extension from `extension/dist/` in Chrome developer mode

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5. Repo / File Layout  
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/api                     â† Vercel Serverless Functions
  save.ts                â† Main save endpoint with deduplication
  delete.ts              â† Delete endpoint for removing records
  tags.ts                â† Dynamic tag suggestions endpoint  
  src/
    airtable.ts          â† Airtable API helpers (findByUrl, create, update, deleteRecord, detectContentType)
    canonical.ts         â† URL canonicalization utilities

/extension               â† Chrome Extension (MV3)
  popup.tsx              â† React popup with auto-save and delete functionality
  popup.html             â† Extension popup entry point
  background.ts          â† Service worker
  manifest.json          â† Extension manifest
  vite.config.ts         â† Build configuration with manifest copy plugin
  utils/api.ts           â† API client utilities (getTags, postSave, deleteEntry)

/backend                 â† Legacy backend (tests only)
  src/                   â† Shared utilities
  tests/
    canonical.test.ts    â† 11 URL canonicalization test cases
    save.test.ts         â† API endpoint tests with mocking

/root
  spec.txt               â† This specification
  README.md              â† User documentation
  iOS-Integration.md     â† iOS Shortcuts integration guide
  vercel.json            â† Vercel deployment config
  .github/workflows/ci.yml â† CI/CD pipeline

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6. Testing & CI/CD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Test Framework: Vitest with Edge Runtime environment
Coverage:

Canonical URL Tests (11 test cases):
1. Normalize scheme and host to lowercase
   Input: "HTTPS://EXAMPLE.COM/Path"
   Expected: "https://example.com/Path"

2. Remove trailing slash from path
   Input: "https://example.com/path/"
   Expected: "https://example.com/path"

3. Keep root path slash
   Input: "https://example.com/"
   Expected: "https://example.com/"

4. Remove UTM parameters
   Input: "https://example.com?utm_source=google&utm_medium=cpc&utm_campaign=test"
   Expected: "https://example.com/"

5. Remove click tracking parameters
   Input: "https://example.com?gclid=123&fbclid=456&yclid=789"
   Expected: "https://example.com/"

6. Remove MailChimp and other tracking parameters
   Input: "https://example.com?mc_cid=test&spm=123&gbraid=abc"
   Expected: "https://example.com/"

7. Remove Vero and referral parameters
   Input: "https://example.com?vero_conv=1&ref=twitter&ref_src=social"
   Expected: "https://example.com/"

8. Preserve non-tracking parameters
   Input: "https://example.com?page=1&sort=name&utm_source=test"
   Expected: "https://example.com/?page=1&sort=name"

9. Handle complex URLs with all transformations
   Input: "HTTPS://EXAMPLE.COM/Path/?utm_source=google&page=1&gclid=123&sort=date&mc_cid=test"
   Expected: "https://example.com/Path?page=1&sort=date"

10. Remove Twitter/X sharing parameters
    Input: "https://x.com/karpathy/status/1938626382248149433?s=46"
    Expected: "https://x.com/karpathy/status/1938626382248149433"

11. Throw error for invalid URLs
    Input: "not-a-url"
    Expected: Throws "Invalid URL" error

Save API Tests:
â€¢ OPTIONS request handling with CORS headers
â€¢ Method validation (405 for non-POST)
â€¢ JSON parsing error handling (400 for invalid JSON)
â€¢ Request validation (400 for missing required fields)
â€¢ Successful record creation (201 response)
â€¢ Duplicate detection and handling
â€¢ Service error handling (502 for external API failures)
â€¢ Complete endpoint testing with mocked Airtable responses

Build Commands:
â€¢ Extension: cd extension && npm run build â†’ extension/dist/
â€¢ Backend: vercel --prod (auto-deploys from /api directory)

Deployment:
â€¢ Backend: Vercel Serverless Functions (auto-deploy from /api)
â€¢ Extension: Manual load from extension/dist/ in Chrome developer mode

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7. Current Behavior & Acceptance Tests
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ” Auto-save on popup open â†’ immediate save with "Saving..." button state
âœ” Unique URL â†’ button shows "Saved" (green, disabled)
âœ” Duplicate URL â†’ form populated with existing title/tags, button shows "Saved"
âœ” Edit populated fields â†’ button changes to "Update Changes" (orange)
âœ” Click update â†’ saves changes, button returns to "Saved" state
âœ” Type detection â†’ Twitter/Reddit/Video/Article auto-assigned based on hostname
âœ” Tag suggestions â†’ fetched fresh from Airtable, typeahead filtering
âœ” Network error â†’ button stays in loading state, no toast messages
âœ” URL canonicalization â†’ tracking + YouTube + Twitter params removed, normalized
âœ” Status field â†’ "To do" automatically set for new entries
âœ” YouTube deduplication â†’ URLs with playlists/timestamps treated as same video
âœ” Twitter deduplication â†’ URLs with sharing parameters (s=46) treated as same tweet
âœ” Form population â†’ existing entries auto-fill for easy editing
âœ” Button-only feedback â†’ no toast messages, all status in button
âœ” Delete functionality â†’ ğŸ—‘ï¸ button appears for saved records, confirmation dialog
âœ” Delete success â†’ form state reset, button disappears
âœ” Adaptive popup width â†’ 320px-500px range, content-responsive

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
8. Current Implementation Notes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Auto-save happens immediately on popup open (no debouncing)
â€¢ Form population from existing entries for easy editing
â€¢ No toast messages - all feedback through button states only
â€¢ No undo functionality (removed from original spec)
â€¢ No caching in chrome.storage (tags fetched fresh each time)
â€¢ Change tracking compares against original saved data
â€¢ Button disabled when no changes detected or when loading
â€¢ Uses native fetch API instead of axios
â€¢ No Chakra UI (custom inline styles)
â€¢ Vercel Serverless Functions instead of Edge Runtime
â€¢ URL-based deduplication instead of hash-based
â€¢ Enhanced URL canonicalization (YouTube playlists/timestamps, Twitter sharing params)
â€¢ Two-phase save: populate first, update on demand with forceUpdate flag
â€¢ Delete functionality with confirmation dialog and form state reset
â€¢ Adaptive popup dimensions (320-500px width, 300px min-height)
â€¢ Console debug logging for delete operations (temporary for troubleshooting)