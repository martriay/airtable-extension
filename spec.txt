APP SPEC — "Save to Airtable" (Current Implementation v3.0)

──────────────────────────────────
0. Goal
──────────────────────────────────
• Chrome browser extension with instant auto-save functionality.
• Capture Title, URL (editable), Tags → write to Airtable Units table.
• Smart content type detection and URL-based deduplication.
• Real-time change tracking with conditional updates.
• Form population from existing entries for easy editing.
• Button-only feedback system (no toast messages).
• Enter key support for quick updates.
• Status management with "Mark as Done" and "Mark as Next" functionality.
• Smart status display with colloquial date formatting.
• Undo functionality for status changes.

──────────────────────────────────
1. Airtable Schema
──────────────────────────────────
BASE: env AIRTABLE_BASE_ID
TABLE: Units (default) or env AIRTABLE_TABLE

Field         Type            Required    Filled by app   Value
------------  --------------  ----------  -------------   -------------------------
Name          Single-line     yes         yes             page title (cleaned)
Link          URL             yes         yes             canonical URL
Tags          Multiple-select no          yes             array of tag strings (auto-created)
Status        Single-select   no          optional        "To do" (when supported)
Type          Single-select   no          optional        auto-detected content type
Done date     Date            no          optional        completion date (YYYY-MM-DD)

Optional Single-Select Options (if fields exist):
Status: "To do", "In progress", "Next", "Done"
Type: "Twitter thread", "Reddit thread", "Video", "Article"

Note: Status and Type fields are optional to handle tables without these fields.

Tag Creation Process:
• Multiple-select field with dynamic option creation via typecast parameter
• User enters any tags (existing or new) in extension
• API cleans tags but does NOT filter out new ones
• Airtable API call includes typecast:true parameter
• Airtable automatically creates new multiple-select options for unknown tags
• Record is saved with all tags (both existing and newly created)
• New tags immediately become available for future use

──────────────────────────────────
2. Backend API
──────────────────────────────────
Platform: Vercel Serverless Functions
Env:
  AIRTABLE_PAT
  AIRTABLE_BASE_ID  
  AIRTABLE_TABLE=Units
  BASIC_AUTH_USERNAME
  BASIC_AUTH_PASSWORD

Security: HTTP Basic Authentication
• All API endpoints require Basic Auth credentials
• Username/password sent via Authorization header: Basic base64(username:password)
• Chrome extension includes credentials in all API requests
• iOS Shortcuts use built-in Basic Auth action
• 401 Unauthorized returned for missing/invalid credentials

POST /api/save  body:
{
  "url":   "<raw url>",
  "title": "<page title>",
  "tags":  ["tag1","tag2"],
  "source":"Extension",
  "forceUpdate": boolean (optional),
  "recordId": "recXXXXXX" (optional)
}
Returns: {duplicate:boolean, id?:string, existingId?:string, existingData?:{title:string,tags:string[]}, error?:string, details?:string}

GET /api/tags
Returns: {"tags": ["tag1","tag2"...], "count": N}

POST /api/check body:
{
  "url": "<raw url>"
}
Returns: {"exists": boolean, "recordId"?: string, "canonicalUrl"?: string, "existingData"?: {"title": string, "tags": string[], "status"?: string, "doneDate"?: string}, "error"?: string, "details"?: string}

DELETE /api/delete body:
{
  "recordId": "recXXXXXX"
}
Returns: {"success": boolean, "error"?: string, "details"?: string}

POST /api/mark-done body:
{
  "recordId": "recXXXXXX",
  "doneDate": "YYYY-MM-DD" (optional, user's local date)
}
Returns: {"success": boolean, "recordId"?: string, "doneDate"?: string, "error"?: string, "details"?: string}

POST /api/mark-next body:
{
  "recordId": "recXXXXXX"
}
Returns: {"success": boolean, "recordId"?: string, "status"?: string, "error"?: string, "details"?: string}

POST /api/mark-todo body:
{
  "recordId": "recXXXXXX"
}
Returns: {"success": boolean, "recordId"?: string, "status"?: string, "error"?: string, "details"?: string}

Process (/api/save):
1. Clean title (cleanTitle function)
   • remove site suffixes: "- YouTube", "| Twitter", "- Reddit", etc.
   • handle various separators: -, |, –, —
   • preserve original if cleaning removes everything
2. Canonicalise URL (canonicalize function)
   • lower-case scheme+host, drop trailing "/"
   • strip tracking params: utm_*, gclid, fbclid, yclid, mc_*, irclickid,
     spm, gbraid, wbraid, vero_*, ref, ref_*
   • YouTube-specific: list, index, t, start, end, feature, app, si, pp,
     ab_channel, source, kw, gws_rd, ei, ved, usg, sa, rlz, biw, bih
   • Twitter/X-specific: s (sharing parameter)
3. Dedup by URL (findByUrl function)
   GET Units?filterByFormula={Link}="canonical_url"
   if exists AND !forceUpdate → return 200 {duplicate:true,existingId,existingData:{title,tags}}
   if exists AND forceUpdate → update record, return 200 {duplicate:true,existingId}
4. Process tags (processTagsForCreation function)
   • clean tags: trim whitespace, remove empty strings
   • length limit: max 100 characters per tag
   • no filtering - all cleaned tags are preserved (existing + new)
5. Detect content type (detectContentType function) - OPTIONAL
   hostname-based: twitter.com/x.com → "Twitter thread"
                   reddit.com → "Reddit thread"
                   youtube.com/vimeo.com/twitch.tv/tiktok.com → "Video"
                   default → "Article"
6. If unique (create function)
   POST Units {Name, Link, Tags, Status?:"To do", Type?:detected_type, typecast:true}
   • typecast:true enables automatic creation of new multiple-select options
   • existing tags: used as-is from current Airtable field options
   • new tags: automatically added to Airtable field options + applied to record
   • result: record saved with all tags (existing + newly created)
   return 201 {duplicate:false,id}
Errors → 4xx/5xx {error,details}

──────────────────────────────────
3. Browser Extension (MV3)
──────────────────────────────────
Tech Stack: React + TypeScript + Vite

manifest.json (auto-generated by Vite plugin):
{
  "manifest_version": 3,
  "name": "Save to Airtable",
  "version": "1.0.0",
  "permissions": ["storage","activeTab"],
  "host_permissions": ["https://*/*", "http://*/*"],
  "action": { "default_popup": "popup.html" },
  "background": { "service_worker": "background.js" }
}

popup.tsx (React component):
 Title  <textarea value={title} onChange={handleTitleChange} onKeyDown={handleTitleKeyDown} rows={2}>
 URL    <textarea value={url} onChange={handleUrlChange} onKeyDown={handleUrlKeyDown} rows={2}>
 Tags   <input value={tags} onChange={handleTagsChange} onKeyDown={handleKeyDown} (with typeahead)>
                         [Save/Update/Status Button] [Done] [Next] [Delete]
                         (main button shows status)   (✓)   (▶️)  (🗑️)

Behaviour:
• On mount (useEffect) - Smart Initialization
    – chrome.tabs.query → get title + url from active tab
    – cleanTitle() → remove site suffixes from title
    – Parallel execution:
      • fetch("/api/tags") → populate availableTags for suggestions
      • POST("/api/check") → check if URL already exists
    – If URL exists: populate form with existing data (no save needed)
    – If URL is new: performSave(url, cleanedTitle, []) → auto-save
• On input change → checkForChanges() → set hasUnsavedChanges flag
• Keyboard shortcuts:
    – Enter on Title/URL/Tags → trigger save (if hasUnsavedChanges && savedRecordId)
    – Shift+Enter → new line (for textareas)
    – Arrow keys in Tags → navigate suggestions
    – Enter with suggestion → accept suggestion
    – Escape → close suggestions
• Button states (ONLY feedback mechanism):
    – isLoading: "Saving..." (gray, disabled)
    – !hasUnsavedChanges && savedRecordId: Status display (gray, non-clickable)
      • "Done today" / "Done on [date]" (colloquial date format)
      • "Next" (simple status)
      • "To do" (simple status)
      • "Status: [other]" (prefixed for unknown statuses)
    – hasUnsavedChanges: "Update" (purple, enabled)
    – default: "Save to Airtable" (blue, enabled)
• Action buttons (when savedRecordId exists):
    – Done button (✓): Toggle between mark as done / undo to "To do"
      • Inactive: white background, green border (clickable)
      • Active (done): light green background, dark green text (clickable to undo)
    – Next button (▶️): Toggle between mark as next / undo to "To do"
      • Inactive: white background, blue border (clickable)
      • Active (next): light blue background, dark blue text (clickable to undo)
    – Delete button (🗑️): red border, always available (immediate action)
• performSave()
    POST /api/save
    duplicate with existingData → populate form fields with current values
    duplicate with forceUpdate → update existing record
    created → set savedRecordId, mark as saved
    error → keep in error state (no toast)
• Form population: When duplicate found, auto-fill title + tags from Airtable
• Tag suggestions: typeahead filtering from availableTags, comma-separated
• Tag creation workflow:
    – User types any tag (existing or new) in tags input field
    – Existing tags show in typeahead suggestions
    – New tags can be typed freely (no validation/filtering)
    – On save: all tags (existing + new) sent to API with typecast:true
    – New tags automatically created in Airtable multiple-select field
    – Next time extension opens: new tags appear in suggestions
• Update workflow: forceUpdate=true when hasUnsavedChanges && savedRecordId
• Delete button: visible when savedRecordId exists, immediate action (no confirmation dialog)
• Status management workflow:
    – Mark as Done: sets Status="Done", Done date=today in user's timezone (YYYY-MM-DD)
    – Mark as Next: sets Status="Next", clears Done date
    – Undo (from active buttons): sets Status="To do", clears Done date
    – Status buttons are toggles: clicking active status reverts to "To do"
• Date formatting: colloquial display ("Done today", "Done yesterday", "Done on Month Dth, YYYY")
  with timezone-safe parsing to avoid date shifting issues

Dependencies: react, react-dom (no Chakra UI, no axios, no toast library)

──────────────────────────────────
4. Development Tools
──────────────────────────────────
• Standard build process: `npm run build` creates production-ready extension
• Manual testing: Load extension from `extension/dist/` in Chrome developer mode
• Testing: `npm test` runs Vitest unit tests

──────────────────────────────────
5. Repo / File Layout  
──────────────────────────────────
/api                     ← Vercel Serverless Functions
  save.ts                ← Main save endpoint with deduplication (Status/Type optional)
  tags.ts                ← Dynamic tag suggestions endpoint  
  delete.ts              ← Delete record endpoint
  check.ts               ← Check URL existence with status/date info
  mark-done.ts           ← Mark record as done with date
  mark-next.ts           ← Mark record as next, clear date
  mark-todo.ts           ← Mark record as to do, clear date
  src/
    airtable.ts          ← Airtable API helpers (findByUrl, create, detectContentType, getAllRecords, update, deleteRecord, markAsDone, markAsNext, markAsTodo)
    canonical.ts         ← URL canonicalization utilities

/extension               ← Chrome Extension (MV3)
  popup.tsx              ← React popup with auto-save and Enter key support
  popup.html             ← Extension popup entry point
  background.ts          ← Service worker
  manifest.json          ← Extension manifest
  vite.config.ts         ← Build configuration with manifest plugin
  utils/api.ts           ← API client utilities (getTags, postSave, deleteEntry, markAsDone, markAsNext, markAsTodo)

/backend                 ← Legacy backend (tests only)
  src/                   ← Shared utilities
  tests/
    canonical.test.ts    ← 8 URL test cases
    save.test.ts         ← API endpoint tests with mocking

/root
  spec.txt               ← This specification
  README.md              ← User documentation
  vercel.json            ← Vercel deployment config
  .github/workflows/ci.yml ← CI/CD pipeline
  iOS-Integration.md     ← iOS Shortcut integration guide

──────────────────────────────────
6. Testing & CI/CD
──────────────────────────────────
Test Framework: Vitest with Node environment
Coverage:
• canonical.test.ts: 11 URL canonicalization scenarios (including YouTube and Twitter)
• save.test.ts: 7 API endpoint testing scenarios with mocked Airtable (create, duplicate, update)
• Deduplication tests: URL-based duplicate prevention
• Type detection tests: Smart content classification

Build Commands:
• Extension: cd extension && npm run build → extension/dist/
• Backend: vercel --prod (auto-deploys from /api directory)

Deployment:
• Backend: Vercel Serverless Functions (auto-deploy from /api)
• Extension: Manual load from extension/dist/ in Chrome developer mode

──────────────────────────────────
7. Current Behavior & Acceptance Tests
──────────────────────────────────
✔ Smart popup initialization → check URL first, only save if new (faster for existing URLs)
✔ Title cleaning → site suffixes like "- YouTube", "| Twitter" automatically removed
✔ Unique URL → button shows status information (gray, non-clickable)
✔ Duplicate URL → form populated with existing title/tags/status, button shows status
✔ Edit populated fields → button changes to "Update" (purple)
✔ Click update → saves changes, button returns to status display
✔ Enter key on any field → triggers update (if changes exist)
✔ Shift+Enter → allows multi-line input in textareas
✔ Type detection → Twitter/Reddit/Video/Article auto-assigned (when supported)
✔ Tag suggestions → fetched fresh from Airtable, typeahead filtering
✔ New tag creation → any new tags automatically created in Airtable via typecast
✔ Network error → button stays in loading state
✔ URL canonicalization → tracking + YouTube + Twitter params removed, normalized
✔ Canonical URL display → extension shows cleaned URL instead of raw browser URL
✔ Status field → "To do" automatically set (when field exists)
✔ YouTube deduplication → URLs with playlists/timestamps treated as same video
✔ Form population → existing entries auto-fill for easy editing
✔ Button-only feedback → no toast messages, all status in buttons
✔ Delete button → visible when saved, immediate action (no confirmation dialog)
✔ Flexible schema → works with tables that don't have Status/Type fields
✔ Status management → Mark as Done/Next buttons with visual toggle states
✔ Undo functionality → Active status buttons clickable to revert to "To do"
✔ Smart date display → "Done today", "Done yesterday", "Done on Month Dth, YYYY"
✔ Timezone-safe dates → Local date parsing prevents day-shifting issues
✔ Status display modes → Clean text for common statuses (Done, Next, To do)
✔ Action button feedback → Visual "turned on" state with colored backgrounds

──────────────────────────────────
8. Current Implementation Notes
──────────────────────────────────
• Smart initialization: check URL existence first, only auto-save if new (performance optimized)
• Title cleaning removes site suffixes using comprehensive regex patterns
• Form population from existing entries for easy editing including status/date info
• No toast messages - all feedback through button states only
• Status management with undo functionality (toggle active statuses back to "To do")
• No caching in chrome.storage (tags fetched fresh each time)
• Change tracking compares against original saved data
• Main button non-clickable when displaying status (purely informational)
• Uses native fetch API instead of axios
• No Chakra UI (custom inline styles)
• Vercel Serverless Functions instead of Edge Runtime
• URL-based deduplication instead of hash-based
• Enhanced YouTube URL canonicalization (playlists, timestamps)
• Two-phase save: populate first, update on demand with forceUpdate flag
• Delete functionality with immediate action (no confirmation dialog)
• Enter key shortcuts for quick updates
• Tag creation via typecast parameter - new multiple-select options auto-created
• Status/Type fields are optional for compatibility with different table schemas
• Graceful degradation when Airtable fields don't exist
• Status workflow: Done (with date) ↔ To do ↔ Next (toggle via action buttons)
• Colloquial date formatting with timezone-safe parsing (prevents day-shifting)
• Visual button states: "turned on" statuses show colored backgrounds but remain clickable
• Color harmony: blue primary, purple update, green done, blue next, red delete
• Clean status text: "Done today", "Next", "To do" (no prefixes for common statuses)
• User timezone support: Done dates use user's local timezone instead of server timezone
• Cute favicon: Cloud icon with transparent background, checkmark, and sparkles