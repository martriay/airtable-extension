APP SPEC â€” "Save to Airtable" (Current Implementation v3.0)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0. Goal
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Chrome browser extension with instant auto-save functionality.
â€¢ Capture Title, URL (editable), Tags â†’ write to Airtable Units table.
â€¢ Smart content type detection and URL-based deduplication.
â€¢ Real-time change tracking with conditional updates.
â€¢ Form population from existing entries for easy editing.
â€¢ Button-only feedback system (no toast messages).
â€¢ Enter key support for quick updates.
â€¢ Status management with "Mark as Done" and "Mark as Next" functionality.
â€¢ Smart status display with colloquial date formatting.
â€¢ Undo functionality for status changes.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Airtable Schema
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE: env AIRTABLE_BASE_ID
TABLE: Units (default) or env AIRTABLE_TABLE

Field         Type            Required    Filled by app   Value
------------  --------------  ----------  -------------   -------------------------
Name          Single-line     yes         yes             page title (cleaned)
Link          URL             yes         yes             canonical URL
Tags          Multiple-select no          yes             array of tag strings (auto-created)
Status        Single-select   no          optional        "To do" (when supported)
Type          Single-select   no          optional        auto-detected content type
Done date     Date            no          optional        completion date (YYYY-MM-DD)

Optional Single-Select Options (if fields exist):
Status: "To do", "In progress", "Next", "Done"
Type: "Twitter thread", "Reddit thread", "Video", "Article"

Note: Status and Type fields are optional to handle tables without these fields.

Tag Creation Process:
â€¢ Multiple-select field with dynamic option creation via typecast parameter
â€¢ User enters any tags (existing or new) in extension
â€¢ API cleans tags but does NOT filter out new ones
â€¢ Airtable API call includes typecast:true parameter
â€¢ Airtable automatically creates new multiple-select options for unknown tags
â€¢ Record is saved with all tags (both existing and newly created)
â€¢ New tags immediately become available for future use

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2. Backend API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Platform: Vercel Serverless Functions
Env:
  AIRTABLE_PAT
  AIRTABLE_BASE_ID  
  AIRTABLE_TABLE=Units
  BASIC_AUTH_USERNAME
  BASIC_AUTH_PASSWORD

Security: HTTP Basic Authentication
â€¢ All API endpoints require Basic Auth credentials
â€¢ Username/password sent via Authorization header: Basic base64(username:password)
â€¢ Chrome extension includes credentials in all API requests
â€¢ iOS Shortcuts use built-in Basic Auth action
â€¢ 401 Unauthorized returned for missing/invalid credentials

POST /api/save  body:
{
  "url":   "<raw url>",
  "title": "<page title>",
  "tags":  ["tag1","tag2"],
  "source":"Extension",
  "forceUpdate": boolean (optional),
  "recordId": "recXXXXXX" (optional)
}
Returns: {duplicate:boolean, id?:string, existingId?:string, existingData?:{title:string,tags:string[]}, error?:string, details?:string}

GET /api/tags
Returns: {"tags": ["tag1","tag2"...], "count": N}

POST /api/check body:
{
  "url": "<raw url>"
}
Returns: {"exists": boolean, "recordId"?: string, "canonicalUrl"?: string, "existingData"?: {"title": string, "tags": string[], "status"?: string, "doneDate"?: string}, "error"?: string, "details"?: string}

DELETE /api/delete body:
{
  "recordId": "recXXXXXX"
}
Returns: {"success": boolean, "error"?: string, "details"?: string}

POST /api/mark-done body:
{
  "recordId": "recXXXXXX",
  "doneDate": "YYYY-MM-DD" (optional, user's local date)
}
Returns: {"success": boolean, "recordId"?: string, "doneDate"?: string, "error"?: string, "details"?: string}

POST /api/mark-next body:
{
  "recordId": "recXXXXXX"
}
Returns: {"success": boolean, "recordId"?: string, "status"?: string, "error"?: string, "details"?: string}

POST /api/mark-todo body:
{
  "recordId": "recXXXXXX"
}
Returns: {"success": boolean, "recordId"?: string, "status"?: string, "error"?: string, "details"?: string}

Process (/api/save):
1. Clean title (cleanTitle function)
   â€¢ remove site suffixes: "- YouTube", "| Twitter", "- Reddit", etc.
   â€¢ handle various separators: -, |, â€“, â€”
   â€¢ preserve original if cleaning removes everything
2. Canonicalise URL (canonicalize function)
   â€¢ lower-case scheme+host, drop trailing "/"
   â€¢ strip tracking params: utm_*, gclid, fbclid, yclid, mc_*, irclickid,
     spm, gbraid, wbraid, vero_*, ref, ref_*
   â€¢ YouTube-specific: list, index, t, start, end, feature, app, si, pp,
     ab_channel, source, kw, gws_rd, ei, ved, usg, sa, rlz, biw, bih
   â€¢ Twitter/X-specific: s (sharing parameter)
3. Dedup by URL (findByUrl function)
   GET Units?filterByFormula={Link}="canonical_url"
   if exists AND !forceUpdate â†’ return 200 {duplicate:true,existingId,existingData:{title,tags}}
   if exists AND forceUpdate â†’ update record, return 200 {duplicate:true,existingId}
4. Process tags (processTagsForCreation function)
   â€¢ clean tags: trim whitespace, remove empty strings
   â€¢ length limit: max 100 characters per tag
   â€¢ no filtering - all cleaned tags are preserved (existing + new)
5. Detect content type (detectContentType function) - OPTIONAL
   hostname-based: twitter.com/x.com â†’ "Twitter thread"
                   reddit.com â†’ "Reddit thread"
                   youtube.com/vimeo.com/twitch.tv/tiktok.com â†’ "Video"
                   default â†’ "Article"
6. If unique (create function)
   POST Units {Name, Link, Tags, Status?:"To do", Type?:detected_type, typecast:true}
   â€¢ typecast:true enables automatic creation of new multiple-select options
   â€¢ existing tags: used as-is from current Airtable field options
   â€¢ new tags: automatically added to Airtable field options + applied to record
   â€¢ result: record saved with all tags (existing + newly created)
   return 201 {duplicate:false,id}
Errors â†’ 4xx/5xx {error,details}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3. Browser Extension (MV3)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tech Stack: React + TypeScript + Vite

manifest.json (auto-generated by Vite plugin):
{
  "manifest_version": 3,
  "name": "Save to Airtable",
  "version": "1.0.0",
  "permissions": ["storage","activeTab"],
  "host_permissions": ["https://*/*", "http://*/*"],
  "action": { "default_popup": "popup.html" },
  "background": { "service_worker": "background.js" }
}

popup.tsx (React component):
 Title  <textarea value={title} onChange={handleTitleChange} onKeyDown={handleTitleKeyDown} rows={2}>
 URL    <textarea value={url} onChange={handleUrlChange} onKeyDown={handleUrlKeyDown} rows={2}>
 Tags   <input value={tags} onChange={handleTagsChange} onKeyDown={handleKeyDown} (with typeahead)>
                         [Save/Update/Status Button] [Done] [Next] [Delete]
                         (main button shows status)   (âœ“)   (â–¶ï¸)  (ğŸ—‘ï¸)

Behaviour:
â€¢ On mount (useEffect) - Smart Initialization
    â€“ chrome.tabs.query â†’ get title + url from active tab
    â€“ cleanTitle() â†’ remove site suffixes from title
    â€“ Parallel execution:
      â€¢ fetch("/api/tags") â†’ populate availableTags for suggestions
      â€¢ POST("/api/check") â†’ check if URL already exists
    â€“ If URL exists: populate form with existing data (no save needed)
    â€“ If URL is new: performSave(url, cleanedTitle, []) â†’ auto-save
â€¢ On input change â†’ checkForChanges() â†’ set hasUnsavedChanges flag
â€¢ Keyboard shortcuts:
    â€“ Enter on Title/URL/Tags â†’ trigger save (if hasUnsavedChanges && savedRecordId)
    â€“ Shift+Enter â†’ new line (for textareas)
    â€“ Arrow keys in Tags â†’ navigate suggestions
    â€“ Enter with suggestion â†’ accept suggestion
    â€“ Escape â†’ close suggestions
â€¢ Button states (ONLY feedback mechanism):
    â€“ isLoading: "Saving..." (gray, disabled)
    â€“ !hasUnsavedChanges && savedRecordId: Status display (gray, non-clickable)
      â€¢ "Done today" / "Done on [date]" (colloquial date format)
      â€¢ "Next" (simple status)
      â€¢ "To do" (simple status)
      â€¢ "Status: [other]" (prefixed for unknown statuses)
    â€“ hasUnsavedChanges: "Update" (purple, enabled)
    â€“ default: "Save to Airtable" (blue, enabled)
â€¢ Action buttons (when savedRecordId exists):
    â€“ Done button (âœ“): Toggle between mark as done / undo to "To do"
      â€¢ Inactive: white background, green border (clickable)
      â€¢ Active (done): light green background, dark green text (clickable to undo)
    â€“ Next button (â–¶ï¸): Toggle between mark as next / undo to "To do"
      â€¢ Inactive: white background, blue border (clickable)
      â€¢ Active (next): light blue background, dark blue text (clickable to undo)
    â€“ Delete button (ğŸ—‘ï¸): red border, always available (immediate action)
â€¢ performSave()
    POST /api/save
    duplicate with existingData â†’ populate form fields with current values
    duplicate with forceUpdate â†’ update existing record
    created â†’ set savedRecordId, mark as saved
    error â†’ keep in error state (no toast)
â€¢ Form population: When duplicate found, auto-fill title + tags from Airtable
â€¢ Tag suggestions: typeahead filtering from availableTags, comma-separated
â€¢ Tag creation workflow:
    â€“ User types any tag (existing or new) in tags input field
    â€“ Existing tags show in typeahead suggestions
    â€“ New tags can be typed freely (no validation/filtering)
    â€“ On save: all tags (existing + new) sent to API with typecast:true
    â€“ New tags automatically created in Airtable multiple-select field
    â€“ Next time extension opens: new tags appear in suggestions
â€¢ Update workflow: forceUpdate=true when hasUnsavedChanges && savedRecordId
â€¢ Delete button: visible when savedRecordId exists, immediate action (no confirmation dialog)
â€¢ Status management workflow:
    â€“ Mark as Done: sets Status="Done", Done date=today in user's timezone (YYYY-MM-DD)
    â€“ Mark as Next: sets Status="Next", clears Done date
    â€“ Undo (from active buttons): sets Status="To do", clears Done date
    â€“ Status buttons are toggles: clicking active status reverts to "To do"
â€¢ Date formatting: colloquial display ("Done today", "Done yesterday", "Done on Month Dth, YYYY")
  with timezone-safe parsing to avoid date shifting issues

Dependencies: react, react-dom (no Chakra UI, no axios, no toast library)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4. Development Tools
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Standard build process: `npm run build` creates production-ready extension
â€¢ Manual testing: Load extension from `extension/dist/` in Chrome developer mode
â€¢ Testing: `npm test` runs Vitest unit tests

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5. Repo / File Layout  
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/api                     â† Vercel Serverless Functions
  save.ts                â† Main save endpoint with deduplication (Status/Type optional)
  tags.ts                â† Dynamic tag suggestions endpoint  
  delete.ts              â† Delete record endpoint
  check.ts               â† Check URL existence with status/date info
  mark-done.ts           â† Mark record as done with date
  mark-next.ts           â† Mark record as next, clear date
  mark-todo.ts           â† Mark record as to do, clear date
  src/
    airtable.ts          â† Airtable API helpers (findByUrl, create, detectContentType, getAllRecords, update, deleteRecord, markAsDone, markAsNext, markAsTodo)
    canonical.ts         â† URL canonicalization utilities

/extension               â† Chrome Extension (MV3)
  popup.tsx              â† React popup with auto-save and Enter key support
  popup.html             â† Extension popup entry point
  background.ts          â† Service worker
  manifest.json          â† Extension manifest
  vite.config.ts         â† Build configuration with manifest plugin
  utils/api.ts           â† API client utilities (getTags, postSave, deleteEntry, markAsDone, markAsNext, markAsTodo)

/backend                 â† Legacy backend (tests only)
  src/                   â† Shared utilities
  tests/
    canonical.test.ts    â† 8 URL test cases
    save.test.ts         â† API endpoint tests with mocking

/root
  spec.txt               â† This specification
  README.md              â† User documentation
  vercel.json            â† Vercel deployment config
  .github/workflows/ci.yml â† CI/CD pipeline
  iOS-Integration.md     â† iOS Shortcut integration guide

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6. Testing & CI/CD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Test Framework: Vitest with Node environment
Coverage:
â€¢ canonical.test.ts: 11 URL canonicalization scenarios (including YouTube and Twitter)
â€¢ save.test.ts: 7 API endpoint testing scenarios with mocked Airtable (create, duplicate, update)
â€¢ Deduplication tests: URL-based duplicate prevention
â€¢ Type detection tests: Smart content classification

Build Commands:
â€¢ Extension: cd extension && npm run build â†’ extension/dist/
â€¢ Backend: vercel --prod (auto-deploys from /api directory)

Deployment:
â€¢ Backend: Vercel Serverless Functions (auto-deploy from /api)
â€¢ Extension: Manual load from extension/dist/ in Chrome developer mode

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7. Current Behavior & Acceptance Tests
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ” Smart popup initialization â†’ check URL first, only save if new (faster for existing URLs)
âœ” Title cleaning â†’ site suffixes like "- YouTube", "| Twitter" automatically removed
âœ” Unique URL â†’ button shows status information (gray, non-clickable)
âœ” Duplicate URL â†’ form populated with existing title/tags/status, button shows status
âœ” Edit populated fields â†’ button changes to "Update" (purple)
âœ” Click update â†’ saves changes, button returns to status display
âœ” Enter key on any field â†’ triggers update (if changes exist)
âœ” Shift+Enter â†’ allows multi-line input in textareas
âœ” Type detection â†’ Twitter/Reddit/Video/Article auto-assigned (when supported)
âœ” Tag suggestions â†’ fetched fresh from Airtable, typeahead filtering
âœ” New tag creation â†’ any new tags automatically created in Airtable via typecast
âœ” Network error â†’ button stays in loading state
âœ” URL canonicalization â†’ tracking + YouTube + Twitter params removed, normalized
âœ” Canonical URL display â†’ extension shows cleaned URL instead of raw browser URL
âœ” Status field â†’ "To do" automatically set (when field exists)
âœ” YouTube deduplication â†’ URLs with playlists/timestamps treated as same video
âœ” Form population â†’ existing entries auto-fill for easy editing
âœ” Button-only feedback â†’ no toast messages, all status in buttons
âœ” Delete button â†’ visible when saved, immediate action (no confirmation dialog)
âœ” Flexible schema â†’ works with tables that don't have Status/Type fields
âœ” Status management â†’ Mark as Done/Next buttons with visual toggle states
âœ” Undo functionality â†’ Active status buttons clickable to revert to "To do"
âœ” Smart date display â†’ "Done today", "Done yesterday", "Done on Month Dth, YYYY"
âœ” Timezone-safe dates â†’ Local date parsing prevents day-shifting issues
âœ” Status display modes â†’ Clean text for common statuses (Done, Next, To do)
âœ” Action button feedback â†’ Visual "turned on" state with colored backgrounds

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
8. Current Implementation Notes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Smart initialization: check URL existence first, only auto-save if new (performance optimized)
â€¢ Title cleaning removes site suffixes using comprehensive regex patterns
â€¢ Form population from existing entries for easy editing including status/date info
â€¢ No toast messages - all feedback through button states only
â€¢ Status management with undo functionality (toggle active statuses back to "To do")
â€¢ No caching in chrome.storage (tags fetched fresh each time)
â€¢ Change tracking compares against original saved data
â€¢ Main button non-clickable when displaying status (purely informational)
â€¢ Uses native fetch API instead of axios
â€¢ No Chakra UI (custom inline styles)
â€¢ Vercel Serverless Functions instead of Edge Runtime
â€¢ URL-based deduplication instead of hash-based
â€¢ Enhanced YouTube URL canonicalization (playlists, timestamps)
â€¢ Two-phase save: populate first, update on demand with forceUpdate flag
â€¢ Delete functionality with immediate action (no confirmation dialog)
â€¢ Enter key shortcuts for quick updates
â€¢ Tag creation via typecast parameter - new multiple-select options auto-created
â€¢ Status/Type fields are optional for compatibility with different table schemas
â€¢ Graceful degradation when Airtable fields don't exist
â€¢ Status workflow: Done (with date) â†” To do â†” Next (toggle via action buttons)
â€¢ Colloquial date formatting with timezone-safe parsing (prevents day-shifting)
â€¢ Visual button states: "turned on" statuses show colored backgrounds but remain clickable
â€¢ Color harmony: blue primary, purple update, green done, blue next, red delete
â€¢ Clean status text: "Done today", "Next", "To do" (no prefixes for common statuses)
â€¢ User timezone support: Done dates use user's local timezone instead of server timezone
â€¢ Cute favicon: Cloud icon with transparent background, checkmark, and sparkles